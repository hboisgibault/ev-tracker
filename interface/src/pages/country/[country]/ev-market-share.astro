---
// src/pages/country/[country]/ev-market-share.astro
import Layout from '../../../layouts/Layout.astro';
import ModernChart from '../../../components/ModernChart.jsx';
import { ENERGY_COLORS, ENERGY_LABELS } from '../../../config/energy.js';
import { SITE_URL, DEFAULT_DESCRIPTION } from '../../../config/site.js';
import { loadZones, loadCountryData, getMonthlyStats, getTopModels, getShare } from '../../../utils/data.js';
import { formatPercent, formatNumber } from '../../../utils/format.js';

export function getStaticPaths() {
  const zones = loadZones();
  return zones.map((zone) => ({
    params: { country: zone.slug },
    props: { code: zone.code, name: zone.name, zoneConfig: zone },
  }));
}

const { code: id, name: countryName, zoneConfig } = Astro.props;
const source = zoneConfig?.parsers?.ev?.source || 'Official registration statistics';
const slug = zoneConfig.slug;
const pageUrl = `${SITE_URL}/country/${slug}/ev-market-share`;
const description = `EV market share, BEV/PHEV mix, and trends in ${countryName}. Data source: ${source}.`;

// --- Data Loading Logic ---
const { files, hasFossilData, dataDir } = loadCountryData(id);

const ENERGY_ORDER = hasFossilData
  ? ['FOSSIL', 'LPG_CNG_OTHER', 'HYBRID', 'PHEV', 'BEV']
  : ['DIESEL', 'GASOLINE', 'LPG_CNG_OTHER', 'HYBRID', 'PHEV', 'BEV'];

const monthlyStats = getMonthlyStats({ files, dataDir, hasFossilData });

// Extract Top Models for the latest month
const topModels = getTopModels({ files, dataDir, hasFossilData });

// Datasets for the chart
const chartLabels = monthlyStats.map((s) => s.date);
const datasets = ENERGY_ORDER.map((energyKey) => {
  return {
    label: ENERGY_LABELS[energyKey] || energyKey,
    data: monthlyStats.map((stat) => {
      const vol = stat.byEnergy[energyKey] || 0;
      return stat.total > 0 ? (vol / stat.total) * 100 : 0;
    }),
    borderColor: ENERGY_COLORS[energyKey]?.stroke || '#000',
    backgroundColor: ENERGY_COLORS[energyKey]?.fill || '#ccc',
    fill: true,
    tension: 0.4,
    pointRadius: 0,
    borderWidth: 1,
  };
}).reverse();

// KPI Calculation
const lastMonth = monthlyStats[monthlyStats.length - 1] || { byEnergy: {}, total: 0, date: 'N/A' };
const prevYearMonth = monthlyStats[monthlyStats.length - 13] || { byEnergy: {}, total: 0 };


const bevShare = getShare(lastMonth, ['BEV']);
const bevSharePrev = getShare(prevYearMonth, ['BEV']);
const bevGrowth = bevShare - bevSharePrev;

const phevShare = getShare(lastMonth, ['PHEV']);
const phevSharePrev = getShare(prevYearMonth, ['PHEV']);

const electrifiedShare = bevShare + phevShare;
const electrifiedSharePrev = bevSharePrev + phevSharePrev;
const electrifiedGrowth = electrifiedShare - electrifiedSharePrev;

const totalGrowth = prevYearMonth.total > 0 
  ? ((lastMonth.total - prevYearMonth.total) / prevYearMonth.total * 100)
  : 0;

const thermalShare = hasFossilData ? getShare(lastMonth, ['FOSSIL']) : getShare(lastMonth, ['DIESEL', 'GASOLINE']);
const thermalSharePrev = hasFossilData ? getShare(prevYearMonth, ['FOSSIL']) : getShare(prevYearMonth, ['DIESEL', 'GASOLINE']);
const thermalGrowth = thermalShare - thermalSharePrev;



const monthNames = ["January", "February", "March", "April", "May", "June",
  "July", "August", "September", "October", "November", "December"
];
const [lYear, lMonth] = (lastMonth.date || '2000-01').split('-');
const formattedDate = `${monthNames[parseInt(lMonth) - 1]} ${lYear}`;
const bevVol = lastMonth.byEnergy['BEV'] || 0;
---

<Layout
  title={`EV Market Share in ${countryName}`}
  description={description || DEFAULT_DESCRIPTION}
  url={pageUrl}
  ldJson={{
    '@context': 'https://schema.org',
    '@type': 'Dataset',
    name: `EV Market Share in ${countryName}`,
    description,
    inLanguage: 'en',
    url: pageUrl,
    publisher: {
      '@type': 'Organization',
      name: 'EV Tracker'
    },
    isBasedOn: source,
    spatialCoverage: {
      '@type': 'Place',
      name: countryName
    }
  }}
>
  <div class="space-y-6">

    <!-- Breadcrumb -->
    <nav class="flex" aria-label="Breadcrumb">
        <ol class="flex items-center space-x-4">
            <li>
                <div>
                    <a href="/" class="text-gray-400 hover:text-gray-500">
                        <svg class="flex-shrink-0 h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                        <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" />
                        </svg>
                        <span class="sr-only">Home</span>
                    </a>
                </div>
            </li>
            <li>
                <div class="flex items-center">
                    <svg class="flex-shrink-0 h-5 w-5 text-gray-300" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
                        <path d="M5.555 17.776l8-16 .894.448-8 16-.894-.448z" />
                    </svg>
                    <a href="#" class="ml-4 text-sm font-medium text-gray-500 hover:text-gray-700" aria-current="page">{countryName}</a>
                </div>
            </li>
        </ol>
    </nav>
    
    <div class="flex items-center justify-between">
         <h1 class="text-3xl font-bold text-gray-900">EV Market Share: {countryName}</h1>
         <span class="px-3 py-1 rounded-full text-sm font-semibold bg-blue-100 text-blue-800">
            Last data: {lastMonth.date}
         </span>
    </div>

     <!-- KPIs Grid (Compact) -->
    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
        <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
             <dt class="text-xs font-medium text-gray-500 uppercase">BEV Market Share</dt>
             <dd class="mt-1 text-2xl font-semibold text-gray-900">{formatPercent(bevShare)}</dd>
             <dd class={`text-sm ${bevGrowth === 0 ? 'text-gray-500' : bevGrowth > 0 ? 'text-green-600' : 'text-red-600'}`}>
                {bevGrowth > 0 ? '+' : bevGrowth < 0 ? '' : ''}{bevGrowth.toFixed(1)} pts YoY
             </dd>
        </div>
         <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
             <dt class="text-xs font-medium text-gray-500 uppercase">Electrified (BEV + PHEV)</dt>
             <dd class="mt-1 text-2xl font-semibold text-gray-900">{formatPercent(electrifiedShare)}</dd>
             <dd class={`text-sm ${electrifiedGrowth === 0 ? 'text-gray-500' : electrifiedGrowth > 0 ? 'text-green-600' : 'text-red-600'}`}>
                {electrifiedGrowth > 0 ? '+' : electrifiedGrowth < 0 ? '' : ''}{electrifiedGrowth.toFixed(1)} pts YoY
             </dd>
        </div>
        <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
             <dt class="text-xs font-medium text-gray-500 uppercase">Total Registrations</dt>
             <dd class="mt-1 text-2xl font-semibold text-gray-900">{formatNumber(lastMonth.total)}</dd>
             <dd class={`text-sm ${totalGrowth === 0 ? 'text-gray-500' : totalGrowth > 0 ? 'text-green-600' : 'text-red-600'}`}>
                {totalGrowth > 0 ? '+' : totalGrowth < 0 ? '' : ''}{totalGrowth.toFixed(1)}% YoY
             </dd>
        </div>
         <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
             <dt class="text-xs font-medium text-gray-500 uppercase">Thermal Share</dt>
             <dd class="mt-1 text-2xl font-semibold text-gray-500">{formatPercent(thermalShare)}</dd>
             <dd class={`text-sm ${thermalGrowth === 0 ? 'text-gray-500' : thermalGrowth > 0 ? 'text-green-600' : 'text-red-600'}`}>
                {thermalGrowth > 0 ? '+' : thermalGrowth < 0 ? '' : ''}{thermalGrowth.toFixed(1)} pts YoY
             </dd>
        </div>
    </div>

    <!-- Automated Analysis Text for SEO -->
    <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
        <h2 class="text-xl font-bold text-gray-900 mb-4">Market Analysis - {formattedDate}</h2>
        <div class="prose max-w-none text-gray-600 space-y-4">
            <p>
                In <strong>{formattedDate}</strong>, the automotive market in {countryName} recorded a total of <strong>{formatNumber(lastMonth.total)}</strong> new registrations.
                The adoption of electric vehicles continues to evolve, with Battery Electric Vehicles (BEV) capturing <strong>{formatPercent(bevShare)}</strong> of the market share. 
                This represents a volume of {formatNumber(bevVol)} full-electric cars registered this month.
            </p>
            <p>
                Compared to the same period last year, the BEV market share has {bevGrowth >= 0 ? 'grown' : 'declined'} by <strong>{Math.abs(bevGrowth).toFixed(1)} percentage points</strong>
                (from {formatPercent(bevSharePrev)} in {prevYearMonth.date}).
            </p>
            <p>
                Looking at the broader picture, Plug-in Hybrids (PHEV) achieved a {formatPercent(phevShare)} share. 
                Combined, plug-in vehicles (BEV + PHEV) account for {formatPercent(bevShare + phevShare)} of all new car sales in {countryName} for this period.
            </p>
        </div>
    </div>

    <!-- Chart -->
    <div class="bg-white rounded-lg shadow-sm p-6">
      <h2 class="text-lg font-bold text-gray-800 mb-4">Market Share Evolution - {countryName}</h2>
      <p class="text-sm text-gray-500 mb-2">Click on legend items to toggle</p>
      <p class="text-xs text-gray-400 mb-4">Source: {source}</p>
      <div class="w-full">
        <ModernChart client:only="react" labels={chartLabels} datasets={datasets} title={`Market Share History - ${countryName}`} />
      </div>
    </div>

  </div>
</Layout>
